{% extends "base.html" %}
{% load dashboard_filters %}

{% block extra_css %}
<!-- Highlight.js for syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
{% endblock %}

{% block page_actions %}
<button onclick="manualRefresh()" class="btn btn-sm btn-outline-secondary" id="refreshBtn" disabled>
    <i class="bi bi-arrow-clockwise spin"></i>
</button>
{% endblock %}

{% block content %}
<!-- Last Update Indicator -->
<div class="text-end mb-2" id="updateIndicator" style="display: none;">
    <small class="text-muted">
        <i class="bi bi-clock-history"></i> Last update: <span id="snapshotTimestamp"></span>
    </small>
</div>

<!-- Loading State -->
<div id="loadingState">
    <div class="card shadow-sm">
        <div class="card-body text-center py-5">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="text-muted">Loading Environment Information...</h5>
            <p class="text-muted small">Gathering system data from containers</p>
        </div>
    </div>
</div>

<!-- Content Container (hidden initially) -->
<div id="contentContainer" style="display: none;">
    <div id="errorContainer"></div>
    <div id="envContent"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Fetch environment data
function loadEnvironmentData() {
    fetch('/environment/?ajax=1')
        .then(r => r.json())
        .then(data => {
            // Hide loading, show content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentContainer').style.display = 'block';
            
            // Update last update time from snapshot
            if (data.timestamp) {
                const snapshotDate = new Date(data.timestamp);
                const year = snapshotDate.getFullYear();
                const month = String(snapshotDate.getMonth() + 1).padStart(2, '0');
                const day = String(snapshotDate.getDate()).padStart(2, '0');
                const hours = String(snapshotDate.getHours()).padStart(2, '0');
                const minutes = String(snapshotDate.getMinutes()).padStart(2, '0');
                const seconds = String(snapshotDate.getSeconds()).padStart(2, '0');
                document.getElementById('snapshotTimestamp').textContent = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                document.getElementById('updateIndicator').style.display = 'block';
                
                // Update current snapshot time for comparison
                currentSnapshotTime = snapshotDate.getTime();
            }
            
            // Check for errors
            if (data.error) {
                document.getElementById('errorContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Error:</strong> ${data.error}
                    </div>
                `;
                return;
            }
            
            // Build the content
            let html = '';
            
            // System Resources Card
            html += buildSystemResourcesCard(data.system);
            
            // Python Environment Card
            html += buildPythonCard(data.python);
            
            // R Environment Card
            html += buildRCard(data.r);
            
            // System Environment Card
            html += buildSystemCard(data.system);
            
            // Slurm Configuration Card
            html += buildSlurmCard(data.slurm);
            
            // Startup Scripts Card
            html += buildStartupScriptsCard(data.startup_scripts);
            
            document.getElementById('envContent').innerHTML = html;
            
            // Apply syntax highlighting
            applySyntaxHighlighting();
            
            // Highlight startup scripts with highlight.js
            document.querySelectorAll('code.language-bash').forEach((block) => {
                hljs.highlightElement(block);
            });
        })
        .catch(e => {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentContainer').style.display = 'block';
            document.getElementById('errorContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill"></i> <strong>Error loading data:</strong> ${e.message}
                </div>
            `;
        });
}

function buildSystemResourcesCard(system) {
    if (system.error) return '';
    
    return `
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <i class="bi bi-hdd"></i> System Resources
        </div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card bg-light border-0 h-100">
                        <div class="card-body text-center">
                            <i class="bi bi-cpu fs-1 text-primary mb-3 d-block"></i>
                            <h3 class="mb-1">${system.cpus || 'N/A'}</h3>
                            <p class="text-muted mb-0">CPU Cores</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card bg-light border-0 h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-memory fs-4 text-success me-2"></i>
                                <h6 class="mb-0">Memory</h6>
                            </div>
                            ${system.mem_total ? `
                            <div class="mb-2">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>Used: ${formatBytes(system.mem_used)}</span>
                                    <span>${system.mem_used_pct}%</span>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" style="width: ${system.mem_used_pct}%">
                                        ${system.mem_used_pct}%
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between small text-muted mt-1">
                                    <span>Total: ${formatBytes(system.mem_total)}</span>
                                    <span>Free: ${formatBytes(system.mem_available)}</span>
                                </div>
                            </div>
                            ` : '<p class="text-muted small">No data</p>'}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card bg-light border-0 h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-hdd-fill fs-4 text-info me-2"></i>
                                <h6 class="mb-0">Disk Usage</h6>
                            </div>
                            ${system.disk_total ? `
                            <div class="mb-2">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>Used: ${formatBytes(system.disk_used)}</span>
                                    <span>${system.disk_used_pct}%</span>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar ${system.disk_used_pct > 80 ? 'bg-danger' : system.disk_used_pct > 60 ? 'bg-warning' : 'bg-info'}" 
                                         style="width: ${system.disk_used_pct}%">
                                        ${system.disk_used_pct}%
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between small text-muted mt-1">
                                    <span>Total: ${formatBytes(system.disk_total)}</span>
                                    <span>Free: ${formatBytes(system.disk_available)}</span>
                                </div>
                            </div>
                            ` : '<p class="text-muted small">No data</p>'}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    `;
}

function buildPythonCard(python) {
    if (python.error) {
        return `
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-file-code"></i> Python Environment
            </div>
            <div class="card-body">
                <div class="alert alert-danger small">${python.error}</div>
            </div>
        </div>
        `;
    }
    
    let packagesHtml = '';
    if (python.packages && python.packages.length > 0) {
        packagesHtml = `
        <div class="mt-4">
            <h6 class="mb-3"><i class="bi bi-box-seam"></i> Installed Packages</h6>
            <div class="accordion sub-accordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pythonPackages">
                            <span>View all ${python.packages.length} Python packages</span>
                        </button>
                    </h2>
                    <div id="pythonPackages" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div class="mb-3">
                                <input type="text" class="form-control form-control-sm" id="pythonSearch" placeholder="Search packages..." onkeyup="filterPackages('pythonSearch', 'pythonPackagesTable')">
                            </div>
                            <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0" id="pythonPackagesTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 50%;">Package</th>
                                            <th style="width: 50%;">Version</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${python.packages.map(pkg => `
                                        <tr>
                                            <td><code>${pkg.name}</code></td>
                                            <td>${pkg.version}</td>
                                        </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;
    }
    
    return `
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <span><i class="bi bi-file-code"></i> Python Environment</span>
            ${python.packages ? `<span class="badge bg-light text-dark">${python.packages.length} packages</span>` : ''}
        </div>
        <div class="card-body">
            <div class="info-row">
                <div class="label">Python Version</div>
                <div class="value"><code>${python.version || 'N/A'}</code></div>
            </div>
            ${packagesHtml}
        </div>
    </div>
    `;
}

function buildRCard(r) {
    if (r.error) {
        return `
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-bar-chart-fill"></i> R Environment
            </div>
            <div class="card-body">
                <div class="alert alert-danger small">${r.error}</div>
            </div>
        </div>
        `;
    }
    
    let packagesHtml = '';
    if (r.packages && r.packages.length > 0) {
        packagesHtml = `
        <div class="mt-4">
            <h6 class="mb-3"><i class="bi bi-box-seam"></i> Installed Packages</h6>
            <div class="accordion sub-accordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#rPackages">
                            <span>View all ${r.packages.length} R packages</span>
                        </button>
                    </h2>
                    <div id="rPackages" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div class="mb-3">
                                <input type="text" class="form-control form-control-sm" id="rSearch" placeholder="Search packages..." onkeyup="filterPackages('rSearch', 'rPackagesTable')">
                            </div>
                            <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0" id="rPackagesTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 50%;">Package</th>
                                            <th style="width: 50%;">Version</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${r.packages.map(pkg => `
                                        <tr>
                                            <td><code>${pkg.Package}</code></td>
                                            <td>${pkg.Version}</td>
                                        </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;
    }
    
    return `
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <span><i class="bi bi-bar-chart-fill"></i> R Environment</span>
            ${r.packages ? `<span class="badge bg-light text-dark">${r.packages.length} packages</span>` : ''}
        </div>
        <div class="card-body">
            <div class="info-row">
                <div class="label">R Version</div>
                <div class="value"><code>${r.version || 'N/A'}</code></div>
            </div>
            ${packagesHtml}
        </div>
    </div>
    `;
}

function buildSystemCard(system) {
    let osHtml = '';
    if (system.os_name || system.kernel) {
        osHtml = `
        <div class="mb-4">
            <h6 class="mb-3"><i class="bi bi-ubuntu"></i> Operating System</h6>
            ${system.os_name ? `
            <div class="info-row">
                <div class="label">OS Version</div>
                <div class="value"><code>${system.os_name}</code></div>
            </div>
            ` : ''}
            ${system.kernel ? `
            <div class="info-row">
                <div class="label">Kernel</div>
                <div class="value"><code>${system.kernel}</code></div>
            </div>
            ` : ''}
            ${system.architecture ? `
            <div class="info-row">
                <div class="label">Architecture</div>
                <div class="value"><code>${system.architecture}</code></div>
            </div>
            ` : ''}
        </div>
        `;
    }
    
    let aptHtml = '';
    if (system.apt_packages && system.apt_packages.length > 0) {
        aptHtml = `
        <div class="accordion sub-accordion">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#aptPackages">
                        <span>View all ${system.apt_packages.length} APT packages</span>
                    </button>
                </h2>
                <div id="aptPackages" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <div class="mb-3">
                            <input type="text" class="form-control form-control-sm" id="aptSearch" placeholder="Search packages..." onkeyup="filterPackages('aptSearch', 'aptPackagesTable')">
                        </div>
                        <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                            <table class="table table-sm table-striped mb-0" id="aptPackagesTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="width: 50%;">Package</th>
                                        <th style="width: 50%;">Version</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${system.apt_packages.map(pkg => `
                                    <tr>
                                        <td><code>${pkg.name}</code></td>
                                        <td>${pkg.version}</td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;
    }
    
    return `
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <span><i class="bi bi-boxes"></i> System Environment</span>
            ${system.apt_packages_count ? `<span class="badge bg-light text-dark">${system.apt_packages_count} packages</span>` : ''}
        </div>
        <div class="card-body">
            ${osHtml}
            ${aptHtml}
        </div>
    </div>
    `;
}

function buildStartupScriptsCard(startup_scripts) {
    if (!startup_scripts || Object.keys(startup_scripts).length === 0) {
        return `
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-file-play"></i> Startup Scripts
            </div>
            <div class="card-body">
                <p class="text-muted small mb-0">No startup scripts found</p>
            </div>
        </div>
        `;
    }
    
    let scriptsHtml = '';
    const script_order = ['pre-install.sh', 'post-install.sh', 'pre-startup.sh'];
    
    for (const script_name of script_order) {
        if (startup_scripts[script_name] !== undefined) {
            const script_content = startup_scripts[script_name];
            const has_content = script_content && script_content.trim().length > 0;
            
            scriptsHtml += `
            <div class="accordion sub-accordion mb-3">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#startupScript${script_name.replace(/[^a-zA-Z0-9]/g, '_')}">
                            <span><code>${script_name}</code> ${has_content ? `(${script_content.split('\n').length} lines)` : '(empty)'}</span>
                        </button>
                    </h2>
                    <div id="startupScript${script_name.replace(/[^a-zA-Z0-9]/g, '_')}" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            ${has_content ? `
                            <div style="max-height: 400px; overflow-y: auto;">
                                <pre style="margin: 0; padding: 1rem; background: #1e1e1e; border-radius: 0.25rem;"><code class="language-bash" id="startupScriptContent${script_name.replace(/[^a-zA-Z0-9]/g, '_')}">${escapeHtml(script_content)}</code></pre>
                            </div>
                            ` : '<p class="text-muted small mb-0">Script file exists but is empty</p>'}
                        </div>
                    </div>
                </div>
            </div>
            `;
        }
    }
    
    // Count scripts that actually exist (not just empty strings)
    const existing_scripts_count = script_order.filter(name => 
        startup_scripts[name] !== undefined && startup_scripts[name] !== null
    ).length;
    
    return `
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <span><i class="bi bi-file-play"></i> Startup Scripts</span>
            ${existing_scripts_count > 0 ? `<span class="badge bg-light text-dark">${existing_scripts_count} script${existing_scripts_count !== 1 ? 's' : ''}</span>` : ''}
        </div>
        <div class="card-body">
            <p class="text-muted small mb-3">These scripts are executed during container initialization and affect the runtime environment.</p>
            ${scriptsHtml}
        </div>
    </div>
    `;
}

function buildSlurmCard(slurm) {
    if (slurm.error) {
        return `
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-cpu"></i> Slurm Configuration
            </div>
            <div class="card-body">
                <div class="alert alert-danger small">${slurm.error}</div>
            </div>
        </div>
        `;
    }
    
    return `
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <i class="bi bi-cpu"></i> Slurm Configuration
        </div>
        <div class="card-body">
            ${slurm.version ? `
            <div class="info-row">
                <div class="label">Slurm Version</div>
                <div class="value"><code>${slurm.version}</code></div>
            </div>
            ` : ''}
            
            ${slurm.config ? `
            <div class="mt-4">
                <h6 class="mb-3"><i class="bi bi-file-text"></i> Configuration File (slurm.conf)</h6>
                <div class="terminal" style="max-height: 500px;" id="slurmConfig">${escapeHtml(slurm.config)}</div>
            </div>
            ` : ''}
            
            ${slurm.node_info ? `
            <div class="mt-4">
                <h6 class="mb-3"><i class="bi bi-hdd-network"></i> Node Information</h6>
                <div class="terminal" style="max-height: 400px;" id="nodeInfo">${escapeHtml(slurm.node_info)}</div>
            </div>
            ` : ''}
        </div>
    </div>
    `;
}

function formatBytes(bytes) {
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let size = bytes;
    let unitIndex = 0;
    
    while (size >= 1024 && unitIndex < units.length - 1) {
        size /= 1024;
        unitIndex++;
    }
    
    return size.toFixed(2) + ' ' + units[unitIndex];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function applySyntaxHighlighting() {
    // Syntax highlight slurm.conf
    const configElement = document.getElementById('slurmConfig');
    if (configElement) {
        let configText = configElement.textContent;
        
        configText = configText.split('\n').map(line => {
            if (line.trim().startsWith('#')) {
                return `<span class="ansi-green">${line}</span>`;
            }
            return line.replace(/^(\w+)=(.+)$/, '<span class="ansi-cyan">$1</span>=<span class="ansi-yellow">$2</span>');
        }).join('\n');
        
        configElement.innerHTML = configText;
    }
    
    // Syntax highlight node info
    const nodeInfoElement = document.getElementById('nodeInfo');
    if (nodeInfoElement) {
        let nodeText = nodeInfoElement.textContent;
        
        nodeText = nodeText.split('\n').map(line => {
            return line.replace(/(\w+)=([^\s]+)/g, '<span class="ansi-cyan">$1</span>=<span class="ansi-yellow">$2</span>');
        }).join('\n');
        
        nodeInfoElement.innerHTML = nodeText;
    }
}

function filterPackages(searchId, tableId) {
    const input = document.getElementById(searchId);
    const filter = input.value.toLowerCase();
    const table = document.getElementById(tableId);
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length; j++) {
            const cellText = cells[j].textContent || cells[j].innerText;
            if (cellText.toLowerCase().indexOf(filter) > -1) {
                found = true;
                break;
            }
        }
        
        rows[i].style.display = found ? '' : 'none';
    }
}

// Load data on page load
loadEnvironmentData();

// Track current snapshot time (will be set after data loads)
let currentSnapshotTime = 0;
let checkInterval = null;

// Update snapshot time tracker when data loads
const originalLoadData = loadEnvironmentData;
loadEnvironmentData = function() {
    originalLoadData();
}

function manualRefresh() {
    const btn = document.getElementById('refreshBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i>';
    checkInterval = setInterval(checkForUpdate, 2000);
    location.reload();
}

function checkForUpdate() {
    fetch('/api/snapshot-timestamp/')
        .then(r => r.json())
        .then(data => {
            const newTime = new Date(data.timestamp).getTime();
            if (newTime > currentSnapshotTime) {
                clearInterval(checkInterval);
                const btn = document.getElementById('refreshBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                }
            }
        })
        .catch(e => console.error('Error:', e));
}

// Always start checking for updates (button starts disabled)
checkInterval = setInterval(checkForUpdate, 2000);
</script>
{% endblock %}
