{% extends "base.html" %}
{% load dashboard_filters %}

{% block content %}
<!-- Primera Card: Unit Information -->
{% if env_config %}
<div class="card shadow-sm" style="margin-bottom: 3rem;">
    <div class="card-header text-white text-center py-4" style="background: #1e293b;">
        <h2 class="mb-0" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 2rem;">{{ env_config.display_name }}</h2>
            </div>
    <div class="card-body" style="padding: 1.5rem 1.5rem 0 1.5rem;">
        <p class="text-center mb-3" style="font-size: 1.15rem; line-height: 1.6; color: #334155; font-weight: 400;">{{ env_config.description }}</p>
        
        <div class="text-center mb-4">
            <div class="d-flex gap-2 justify-content-center">
                {% if env_config.project_website %}
                <a href="{{ env_config.project_website }}" target="_blank" class="btn btn-primary">
                    <i class="bi bi-globe"></i> Project Website
                </a>
                {% endif %}
                <a href="https://isglobal-brge.github.io/dsHPC" target="_blank" class="btn btn-secondary">
                    <i class="bi bi-cpu"></i> dsHPC Website
                </a>
                </div>
                </div>
        
        {% if env_config.authors %}
        <!-- Authors Accordions -->
        <div class="accordion" id="authorsAccordion" style="margin-left: -1.5rem; margin-right: -1.5rem;">
            <div class="accordion-item">
                <hr style="margin: 0; padding: 0; border-color: rgba(0,0,0,0.5);">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed text-center justify-content-center" type="button" data-bs-toggle="collapse" data-bs-target="#envAuthors" style="font-weight: 400; font-size: 0.9rem; color: #334155;">
                        {{ env_config.environment_name }} Authors
                    </button>
                </h2>
                <div id="envAuthors" class="accordion-collapse collapse" data-bs-parent="#authorsAccordion">
                    <div class="accordion-body">
                        <div class="row g-3 justify-content-center">
                        {% for author in env_config.authors %}
                        {% if author is not string %}
                        <div class="col-md-6 col-lg-4">
                            <div class="card border-0 h-100" style="background: transparent;">
                                <div class="card-body p-3">
                                    <strong class="d-block mb-1 text-center">{% if author is string %}{{ author }}{% else %}{{ author.name }}{% endif %}</strong>
                                    
                                    {% if author.institution %}
                                    <div class="mb-2 text-center">
                                        {% if author.institution_url %}
                                        <a href="{{ author.institution_url }}" target="_blank" class="text-decoration-none" title="Visit {{ author.institution }}" style="color: inherit;">
                                            <small class="text-muted">{{ author.institution }}</small>
                                        </a>
                                        {% else %}
                                        <small class="text-muted">{{ author.institution }}</small>
                                        {% endif %}
                </div>
                {% endif %}
                                    
                                    <div class="d-flex gap-3 mt-2 justify-content-center" style="font-size: 1.1rem;">
                                        {% if author.email %}<a href="mailto:{{ author.email }}" class="social-icon" title="{{ author.email }}"><i class="bi bi-envelope-fill text-primary"></i></a>{% endif %}
                                        {% if author.website %}<a href="{{ author.website }}" target="_blank" class="social-icon" title="Website"><i class="bi bi-globe text-info"></i></a>{% endif %}
                                        {% if author.orcid %}<a href="https://orcid.org/{{ author.orcid }}" target="_blank" class="social-icon" title="ORCID"><svg width="18" height="18" viewBox="0 0 256 256" style="display: inline-block; vertical-align: -0.15em;"><path fill="#A6CE39" d="M256,128c0,70.7-57.3,128-128,128C57.3,256,0,198.7,0,128C0,57.3,57.3,0,128,0C198.7,0,256,57.3,256,128z"/><g><path fill="#FFFFFF" d="M86.3,186.2H70.9V79.1h15.4v48.4V186.2z"/><path fill="#FFFFFF" d="M108.9,79.1h41.6c39.6,0,57,28.3,57,53.6c0,27.5-21.5,53.6-56.8,53.6h-41.8V79.1z M124.3,172.4h24.5c34.9,0,42.9-26.5,42.9-39.7c0-21.5-13.7-39.7-43.7-39.7h-23.7V172.4z"/><path fill="#FFFFFF" d="M88.7,56.8c0,5.5-4.5,10.1-10.1,10.1c-5.6,0-10.1-4.6-10.1-10.1c0-5.6,4.5-10.1,10.1-10.1C84.2,46.7,88.7,51.3,88.7,56.8z"/></g></svg></a>{% endif %}
                                        {% if author.linkedin %}<a href="{{ author.linkedin }}" target="_blank" class="social-icon" title="LinkedIn"><i class="bi bi-linkedin text-primary"></i></a>{% endif %}
                                        {% if author.github %}<a href="https://github.com/{{ author.github }}" target="_blank" class="social-icon" title="GitHub"><i class="bi bi-github text-dark"></i></a>{% endif %}
            </div>
            </div>
        </div>
    </div>
                        {% endif %}
                        {% endfor %}
                        </div>
            </div>
                </div>
            </div>
            
            <!-- dsHPC Authors Accordion -->
            <div class="accordion-item">
                <hr style="margin: 0; padding: 0; border-color: rgba(0,0,0,0.5);">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed text-center justify-content-center" type="button" data-bs-toggle="collapse" data-bs-target="#dshpcAuthors" style="font-weight: 400; font-size: 0.9rem; color: #334155;">
                        dsHPC Authors
                    </button>
                </h2>
                <div id="dshpcAuthors" class="accordion-collapse collapse" data-bs-parent="#authorsAccordion">
                    <div class="accordion-body">
                        <div class="row g-3 justify-content-center">
                        {% for author in dshpc_authors %}
                        <div class="col-md-6 col-lg-4">
                            <div class="card border-0 h-100" style="background: transparent;">
                                <div class="card-body p-3">
                                    <strong class="d-block mb-1 text-center">{{ author.name }}</strong>
                                    
                                    {% if author.institution %}
                                    <div class="mb-2 text-center">
                                        {% if author.institution_url %}
                                        <a href="{{ author.institution_url }}" target="_blank" class="text-decoration-none" title="Visit {{ author.institution }}" style="color: inherit;">
                                            <small class="text-muted">{{ author.institution }}</small>
                                        </a>
                                        {% else %}
                                        <small class="text-muted">{{ author.institution }}</small>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <div class="d-flex gap-3 mt-2 justify-content-center" style="font-size: 1.1rem;">
                                        {% if author.email %}<a href="mailto:{{ author.email }}" class="social-icon" title="{{ author.email }}"><i class="bi bi-envelope-fill text-primary"></i></a>{% endif %}
                                        {% if author.website %}<a href="{{ author.website }}" target="_blank" class="social-icon" title="Website"><i class="bi bi-globe text-info"></i></a>{% endif %}
                                        {% if author.orcid %}<a href="https://orcid.org/{{ author.orcid }}" target="_blank" class="social-icon" title="ORCID"><svg width="18" height="18" viewBox="0 0 256 256" style="display: inline-block; vertical-align: -0.15em;"><path fill="#A6CE39" d="M256,128c0,70.7-57.3,128-128,128C57.3,256,0,198.7,0,128C0,57.3,57.3,0,128,0C198.7,0,256,57.3,256,128z"/><g><path fill="#FFFFFF" d="M86.3,186.2H70.9V79.1h15.4v48.4V186.2z"/><path fill="#FFFFFF" d="M108.9,79.1h41.6c39.6,0,57,28.3,57,53.6c0,27.5-21.5,53.6-56.8,53.6h-41.8V79.1z M124.3,172.4h24.5c34.9,0,42.9-26.5,42.9-39.7c0-21.5-13.7-39.7-43.7-39.7h-23.7V172.4z"/><path fill="#FFFFFF" d="M88.7,56.8c0,5.5-4.5,10.1-10.1,10.1c-5.6,0-10.1-4.6-10.1-10.1c0-5.6,4.5-10.1,10.1-10.1C84.2,46.7,88.7,51.3,88.7,56.8z"/></g></svg></a>{% endif %}
                                        {% if author.linkedin %}<a href="{{ author.linkedin }}" target="_blank" class="social-icon" title="LinkedIn"><i class="bi bi-linkedin text-primary"></i></a>{% endif %}
                                        {% if author.github %}<a href="https://github.com/{{ author.github }}" target="_blank" class="social-icon" title="GitHub"><i class="bi bi-github text-dark"></i></a>{% endif %}
                                    </div>
            </div>
        </div>
    </div>
                        {% endfor %}
                        </div>
            </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Segunda Card: Container Status - COMPLETAMENTE SEPARADA -->
<div class="card shadow-sm mb-4" style="margin-top: 3rem;">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-hdd-network"></i> System Status</span>
        <small class="text-white-50">
            <i class="bi bi-arrow-repeat"></i> Live updates
        </small>
    </div>
    <div class="card-body" id="containerStatusContent">
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-2">Checking container status...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let statusRefreshInterval;

function refreshContainerStatus() {
    
    fetch('/api/container-status/')
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                document.getElementById('containerStatusContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill"></i> ${data.error}
                    </div>
                `;
                return;
            }
            
            const results = data.containers;
            renderContainerStatus(results, data.age_seconds);
        })
        .catch(error => {
            document.getElementById('containerStatusContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill"></i> Error: ${error.message}
            </div>
            `;
        });
}

function renderContainerStatus(results, ageSeconds) {
        let html = '';
        
        // Add last updated indicator
        if (ageSeconds !== null && ageSeconds !== undefined) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeStr = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            html += `
                <div class="text-muted small mb-3 text-end">
                    <i class="bi bi-clock-history"></i> Last update: ${timeStr}
                </div>
            `;
        }
        
        html += '<div class="row g-3">';
        
        results.forEach(result => {
            let statusClass = result.status === 'running' ? 'success' : result.status === 'stopped' ? 'danger' : 'secondary';
            let statusIcon = result.status === 'running' ? 'check-circle-fill' : result.status === 'stopped' ? 'x-circle-fill' : 'question-circle';
            let statusText = result.status.toUpperCase();
            let cardBorder = result.status === 'running' ? 'border-success' : result.status === 'stopped' ? 'border-danger' : 'border-secondary';
            let typeClass = result.type === 'service' ? 'bg-primary' : 'bg-info';
            
            // Check if this is a service (clickable to logs)
            let isClickable = result.type === 'service';
            let cardClass = isClickable ? 'card h-100 ' + cardBorder + ' container-card-clickable' : 'card h-100 ' + cardBorder;
            let onclick = isClickable ? `onclick="window.location.href='/logs/?container=${result.name}'"` : '';
            let cursorStyle = isClickable ? 'cursor: pointer;' : '';
            
            html += `
                <div class="col-md-6 col-lg-4">
                    <div class="${cardClass}" style="border-width: 2px; ${cursorStyle}" ${onclick}>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <i class="bi bi-${result.icon} fs-4 text-${statusClass}"></i>
                                        <h6 class="mb-0">${result.displayName}</h6>
            </div>
                                    <small class="text-muted d-block">${result.name}</small>
            </div>
                                <span class="badge bg-${statusClass}">
                                    <i class="bi bi-${statusIcon}"></i> ${statusText}
                                </span>
        </div>
                            
                            <div class="mt-2">
                                <small class="text-muted">Type:</small>
                                <span class="badge ${typeClass} ms-1">${result.type}</span>
                                ${isClickable ? '<i class="bi bi-arrow-right-circle ms-2 text-muted"></i>' : ''}
</div>

                            ${result.error ? `
                            <div class="mt-2">
                                <small class="text-danger"><i class="bi bi-exclamation-triangle"></i> ${result.error}</small>
            </div>
                            ` : ''}
                </div>
            </div>
        </div>
            `;
        });
        
    html += '</div>';
    
    // Add summary
    const runningCount = results.filter(r => r.status === 'running').length;
    const totalCount = results.length;
    
    html += `
    <div class="mt-4 text-center">
        <h5 class="mb-2">
            <span class="badge bg-${runningCount === totalCount ? 'success' : runningCount > 0 ? 'warning' : 'danger'} fs-6">
                ${runningCount} / ${totalCount} containers running
            </span>
        </h5>
        ${runningCount === totalCount ? 
            '<p class="text-success mb-0"><i class="bi bi-check-circle-fill"></i> All systems operational</p>' : 
            '<p class="text-warning mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Some containers are not running</p>'
        }
    </div>
    `;
    
    document.getElementById('containerStatusContent').innerHTML = html;
}

// Initial load
refreshContainerStatus();

// Auto-refresh every 10 seconds (silent, matches worker interval)
statusRefreshInterval = setInterval(refreshContainerStatus, 10000);

// Cleanup
window.addEventListener('beforeunload', () => {
    if (statusRefreshInterval) clearInterval(statusRefreshInterval);
});

// No custom toggle function needed - Bootstrap handles accordion
</script>
{% endblock %}
