{% extends "base.html" %}
{% load dashboard_filters %}

{% block content %}
<!-- Unit Information -->
{% if env_config %}
<div class="card shadow-sm mb-4">
    <div class="card-body p-4">
        <div class="text-center mb-4">
            <i class="bi bi-hdd-network-fill fs-1 text-primary mb-3 d-block"></i>
            <h2 class="mb-2">{{ env_config.display_name }}</h2>
            <p class="text-muted">{{ env_config.description }}</p>
        </div>
        
        {% if env_config.authors %}
        <div class="text-center mb-3">
            <small class="text-muted d-block mb-2">Developed by</small>
            <div class="d-flex justify-content-center gap-3 flex-wrap">
                {% for author in env_config.authors %}
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-person-circle text-primary"></i>
                    <span>{{ author }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <hr class="my-4">
        
        <div class="row text-center">
            <div class="col-md-4">
                <small class="text-muted d-block mb-1">Stack Prefix</small>
                <code>{{ env_config.docker_stack_prefix }}</code>
            </div>
            <div class="col-md-4">
                <small class="text-muted d-block mb-1">API Port</small>
                <code>{{ env_config.default_api_port }}</code>
            </div>
            <div class="col-md-4">
                <small class="text-muted d-block mb-1">Admin Port</small>
                <code>{{ env_config.default_admin_port }}</code>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Container Status -->
<div class="card shadow-sm">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-hdd-network"></i> System Status</span>
        <button onclick="refreshContainerStatus()" class="btn btn-sm btn-light" id="refreshStatusBtn">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
    </div>
    <div class="card-body" id="containerStatusContent">
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-2">Checking container status...</p>
        </div>
    </div>
    <div class="card-footer text-muted small">
        <i class="bi bi-info-circle"></i> Auto-refreshing every 10 seconds
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let statusRefreshInterval;

function refreshContainerStatus() {
    const btn = document.getElementById('refreshStatusBtn');
    if (btn) btn.disabled = true;
    
    const prefix = '{{ docker_prefix }}';
    const containers = [
        { name: `${prefix}-api`, displayName: 'API Server', icon: 'server', type: 'service' },
        { name: `${prefix}-slurm`, displayName: 'Slurm Service', icon: 'cpu', type: 'service' },
        { name: `${prefix}-admin`, displayName: 'Admin Panel', icon: 'speedometer2', type: 'service' },
        { name: `${prefix}-jobs`, displayName: 'Jobs Database', icon: 'database', type: 'database' },
        { name: `${prefix}-files`, displayName: 'Files Database', icon: 'database', type: 'database' },
        { name: `${prefix}-methods`, displayName: 'Methods Database', icon: 'database', type: 'database' }
    ];
    
    Promise.all(containers.map(container => 
        fetch(`/logs/?container=${container.name}&lines=1&ajax=1`)
            .then(r => r.json())
            .then(data => ({
                ...container,
                status: data.error ? 'stopped' : 'running',
                error: data.error
            }))
            .catch(() => ({
                ...container,
                status: 'unknown',
                error: 'Cannot connect'
            }))
    )).then(results => {
        let html = '<div class="row g-3">';
        
        results.forEach(result => {
            let statusClass = result.status === 'running' ? 'success' : result.status === 'stopped' ? 'danger' : 'secondary';
            let statusIcon = result.status === 'running' ? 'check-circle-fill' : result.status === 'stopped' ? 'x-circle-fill' : 'question-circle';
            let statusText = result.status.toUpperCase();
            let cardBorder = result.status === 'running' ? 'border-success' : result.status === 'stopped' ? 'border-danger' : 'border-secondary';
            
            html += `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 ${cardBorder}" style="border-width: 2px;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <i class="bi bi-${result.icon} fs-4 text-${statusClass}"></i>
                                        <h6 class="mb-0">${result.displayName}</h6>
                                    </div>
                                    <small class="text-muted d-block">${result.name}</small>
                                </div>
                                <span class="badge bg-${statusClass}">
                                    <i class="bi bi-${statusIcon}"></i> ${statusText}
                                </span>
                            </div>
                            
                            <div class="mt-2">
                                <small class="text-muted">Type:</small>
                                <span class="badge bg-secondary ms-1">${result.type}</span>
                            </div>
                            
                            ${result.error ? `
                            <div class="mt-2">
                                <small class="text-danger"><i class="bi bi-exclamation-triangle"></i> ${result.error}</small>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        // Add summary
        const runningCount = results.filter(r => r.status === 'running').length;
        const totalCount = results.length;
        
        html += `
        <div class="mt-4 text-center">
            <h5 class="mb-2">
                <span class="badge bg-${runningCount === totalCount ? 'success' : runningCount > 0 ? 'warning' : 'danger'} fs-6">
                    ${runningCount} / ${totalCount} containers running
                </span>
            </h5>
            ${runningCount === totalCount ? 
                '<p class="text-success mb-0"><i class="bi bi-check-circle-fill"></i> All systems operational</p>' : 
                '<p class="text-warning mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Some containers are not running</p>'
            }
        </div>
        `;
        
        document.getElementById('containerStatusContent').innerHTML = html;
        if (btn) btn.disabled = false;
    }).catch(error => {
        document.getElementById('containerStatusContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle-fill"></i> Error checking container status: ${error.message}
            </div>
        `;
        if (btn) btn.disabled = false;
    });
}

// Initial load
refreshContainerStatus();

// Auto-refresh every 10 seconds
statusRefreshInterval = setInterval(refreshContainerStatus, 10000);

// Cleanup
window.addEventListener('beforeunload', () => {
    if (statusRefreshInterval) clearInterval(statusRefreshInterval);
});
</script>
{% endblock %}
